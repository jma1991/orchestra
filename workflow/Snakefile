# Author: James Ashmore
# Copyright: Copyright 2020, James Ashmore
# Email: jashmore@ed.ac.uk
# License: MIT

rule all:
    input:
        # Droplet processing
        "analysis/droplet-processing/barcodeRanks.rds",
        "analysis/droplet-processing/barcodeRanksPlot.pdf",
        "analysis/droplet-processing/emptyDrops.rds",
        "analysis/droplet-processing/emptyDrops.ambient.rds",
        "analysis/droplet-processing/emptyDropsLimited.pdf",
        "analysis/droplet-processing/emptyDropsLogProb.pdf",
        "analysis/droplet-processing/emptyDropsPValue.pdf",
        "analysis/droplet-processing/emptyDropsRank.pdf",
        "analysis/droplet-processing/filterByDrops.rds",
        # Quality control
        "analysis/quality-control/perCellQCMetrics.rds",
        "analysis/quality-control/quickPerCellQC.rds",
        "analysis/quality-control/perCellQCMetrics.sum.pdf",
        "analysis/quality-control/perCellQCMetrics.detected.pdf",
        "analysis/quality-control/perCellQCMetrics.subsets_MT_percent.pdf",
        "analysis/quality-control/filterCellsByQC.rds",
        "analysis/quality-control/perFeatureQCMetrics.rds",
        "analysis/quality-control/plotFeatureMean.pdf",
        "analysis/quality-control/plotFeatureDetected.pdf",
        "analysis/quality-control/plotExprsFreqVsMean.pdf",
        "analysis/quality-control/plotHighestExprs.pdf",
        "analysis/quality-control/calculatePCA.rds",
        "analysis/quality-control/calculateTSNE.rds",
        "analysis/quality-control/calculateUMAP.rds",
        expand("analysis/quality-control/plotPCA.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        expand("analysis/quality-control/plotTSNE.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        expand("analysis/quality-control/plotUMAP.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        # Normalization
        "analysis/normalization/librarySizeFactors.rds",
        "analysis/normalization/calculateSumFactors.rds",
        "analysis/normalization/logNormCounts.rds",
        expand("analysis/normalization/plotPCA.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        expand("analysis/normalization/plotTSNE.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        expand("analysis/normalization/plotUMAP.{metric}.pdf", metric = ["sum", "detected", "subsets_MT_percent"]),
        # Feature selection
        "analysis/feature-selection/modelGeneVar.rds",
        "analysis/feature-selection/modelGeneCV2.rds",
        "analysis/feature-selection/modelGeneVarByPoisson.rds",
        "analysis/feature-selection/plotGeneVar.pdf",
        "analysis/feature-selection/plotGeneCV2.pdf",
        "analysis/feature-selection/plotGeneVarByPoisson.pdf",
        "analysis/feature-selection/modelGeneVar.HVG.rds",
        "analysis/feature-selection/modelGeneCV2.HVG.rds",
        "analysis/feature-selection/modelGeneVarByPoisson.HVG.rds",
        "analysis/feature-selection/plotHeatmap.modelGeneVar.HVG.pdf",
        "analysis/feature-selection/plotHeatmap.modelGeneCV2.HVG.pdf",
        "analysis/feature-selection/plotHeatmap.modelGeneVarByPoisson.HVG.pdf",
        "analysis/feature-selection/rowSubset.rds",
        # Dimensionality reduction
        "analysis/reduced-dimensions/calculatePCA.rds",
        "analysis/reduced-dimensions/findElbowPoint.rds",
        "analysis/reduced-dimensions/plotElbowPoint.pdf",
        "analysis/reduced-dimensions/getDenoisedPCs.rds",
        "analysis/reduced-dimensions/plotDenoisedPCs.pdf",
        "analysis/reduced-dimensions/getClusteredPCs.rds",
        "analysis/reduced-dimensions/plotClusteredPCs.pdf",
        "analysis/reduced-dimensions/selectPCs.rds",
        "analysis/reduced-dimensions/parallelTSNE.rds",
        "analysis/reduced-dimensions/visualiseTSNE.pdf",
        "analysis/reduced-dimensions/parallelUMAP.rds",
        "analysis/reduced-dimensions/visualiseUMAP.pdf",
        "analysis/reduced-dimensions/selectTSNE.rds",
        "analysis/reduced-dimensions/selectUMAP.rds",
        "analysis/reduced-dimensions/reducedDims.rds",
        # Clustering
        "analysis/clustering/HclustParam.rds",
        "analysis/clustering/HclustPCAPlot.pdf",
        "analysis/clustering/HclustTSNEPlot.pdf",
        "analysis/clustering/HclustUMAPPlot.pdf",
        "analysis/clustering/HclustSilhouette.rds",
        "analysis/clustering/HclustSilhouettePlot.pdf",
        "analysis/clustering/HclustPurity.rds",
        "analysis/clustering/HclustPurityPlot.pdf",
        "analysis/clustering/KmeansParam.10.rds",
        "analysis/clustering/KmeansPCAPlot.10.pdf",
        "analysis/clustering/KmeansTSNEPlot.10.pdf",
        "analysis/clustering/KmeansUMAPPlot.10.pdf",
        "analysis/clustering/KmeansSilhouette.10.rds",
        "analysis/clustering/KmeansSilhouettePlot.10.pdf",
        "analysis/clustering/KmeansPurity.10.rds",
        "analysis/clustering/KmeansPurityPlot.10.pdf",
        "analysis/clustering/NNGraphParam.10.jaccard.louvain.rds",
        "analysis/clustering/NNGraphPCAPlot.10.jaccard.louvain.pdf",
        "analysis/clustering/NNGraphTSNEPlot.10.jaccard.louvain.pdf",
        "analysis/clustering/NNGraphUMAPPlot.10.jaccard.louvain.pdf",
        "analysis/clustering/NNGraphSilhouette.10.jaccard.louvain.rds",
        "analysis/clustering/NNGraphSilhouettePlot.10.jaccard.louvain.pdf",
        "analysis/clustering/NNGraphPurity.10.jaccard.louvain.rds",
        "analysis/clustering/NNGraphPurityPlot.10.jaccard.louvain.pdf",
        "analysis/clustering/NNGraphModularity.10.jaccard.louvain.rds",
        "analysis/clustering/NNGraphModularityPlot.10.jaccard.louvain.pdf",
        "analysis/clustering/clusterLabels.rds"
        # Doublet detection
        # Cell cycle assignment
        # Marker gene detection
        # Trajectory analysis

# Workflow rules
include: "rules/droplet-processing.smk"
include: "rules/quality-control.smk"
include: "rules/normalization.smk"
include: "rules/feature-selection.smk"
include: "rules/reduced-dimensions.smk"
include: "rules/clustering.smk"
include: "rules/doublet-detection.smk"
include: "rules/cell-cycle.smk"
include: "rules/marker-detection.smk"
include: "rules/trajectory.smk"